# Step 2.1: Create pgvector Initialization Script

**Objective:** Create SQL script to automatically enable pgvector extension on database startup

## Files to Create

- `docker/postgres/init-scripts/01-enable-pgvector.sql`

## Implementation

### Step-by-Step Instructions

#### Step 1: Create Directory Structure

```bash
mkdir -p docker/postgres/init-scripts
```

#### Step 2: Create 01-enable-pgvector.sql

Create the file at `docker/postgres/init-scripts/01-enable-pgvector.sql`:

```sql
-- Enable pgvector extension for RAG vector similarity search
-- This script runs automatically on first database initialization
-- Scripts in /docker-entrypoint-initdb.d/ are executed in alphabetical order

-- Create extension if it doesn't exist
CREATE EXTENSION IF NOT EXISTS vector;

-- Verify extension was created
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_extension WHERE extname = 'vector'
    ) THEN
        RAISE NOTICE 'pgvector extension successfully enabled';
    ELSE
        RAISE EXCEPTION 'Failed to enable pgvector extension';
    END IF;
END $$;

-- Display pgvector version
SELECT extname, extversion 
FROM pg_extension 
WHERE extname = 'vector';
```

**Script Explanation:**

- **CREATE EXTENSION IF NOT EXISTS vector**: Safely enables pgvector (won't fail if already exists)
- **DO $$ block**: Verification logic to ensure extension was created
- **RAISE NOTICE**: Logs success message visible in container logs
- **RAISE EXCEPTION**: Fails initialization if extension not available
- **SELECT statement**: Displays pgvector version in logs for debugging

**Naming Convention:**
- Prefix `01-` ensures this runs first (scripts execute alphabetically)
- Future scripts can use `02-`, `03-`, etc. for ordered execution
- Descriptive name makes purpose clear

## Verification Steps

### 1. Reset Database to Test Init Script

```bash
# Remove existing database to trigger initialization
docker compose down -v

# Start fresh (init scripts run on first startup)
docker compose up -d
```

### 2. Check Logs for Success Message

```bash
docker compose logs postgres | grep -i vector
```

Expected output:
```
dovvydive-postgres  | NOTICE:  pgvector extension successfully enabled
dovvydive-postgres  |  extname | extversion
dovvydive-postgres  | ---------+------------
dovvydive-postgres  |  vector  | 0.5.1
```

### 3. Verify Extension is Installed

Connect to database:
```bash
docker compose exec postgres psql -U dovvydive -d dovvydive
```

Check installed extensions:
```sql
-- List all extensions
\dx

-- Or query pg_extension table
SELECT extname, extversion, extrelocatable, extnamespace::regnamespace 
FROM pg_extension 
WHERE extname = 'vector';
```

Expected output:
```
 extname | extversion | extrelocatable | extnamespace
---------+------------+----------------+--------------
 vector  | 0.5.1      | t              | public
```

### 4. Test Vector Operations

Create a test table with vector column:
```sql
-- Create test table with vector column (3 dimensions)
CREATE TABLE test_vectors (
    id serial PRIMARY KEY,
    embedding vector(3)
);

-- Insert test vectors
INSERT INTO test_vectors (embedding) VALUES 
    ('[1,2,3]'),
    ('[4,5,6]'),
    ('[7,8,9]');

-- Test vector similarity search
SELECT id, embedding, embedding <-> '[1,2,3]' AS distance
FROM test_vectors
ORDER BY distance
LIMIT 3;
```

Expected output (ordered by distance):
```
 id | embedding | distance
----+-----------+----------
  1 | [1,2,3]   | 0
  2 | [4,5,6]   | 5.196152
  3 | [7,8,9]   | 10.392305
```

### 5. Clean Up Test Data

```sql
DROP TABLE test_vectors;
\q
```

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| Script doesn't run | Init scripts only run on FIRST startup | Run `docker compose down -v && docker compose up -d` |
| Extension not found | Wrong pgvector image | Verify using `pgvector/pgvector:pg16` image |
| Permission denied | Script file permissions | Run: `chmod +r docker/postgres/init-scripts/*.sql` |
| Syntax error in script | SQL syntax issue | Check logs: `docker compose logs postgres` for error details |
| Extension exists but can't create vectors | Wrong data type | Use `vector(N)` where N is dimension count |

## Success Criteria

- ✅ Directory `docker/postgres/init-scripts/` exists
- ✅ File `01-enable-pgvector.sql` contains CREATE EXTENSION statement
- ✅ Fresh database startup logs show "pgvector extension successfully enabled"
- ✅ `\dx` command shows `vector` extension installed
- ✅ Can create tables with `vector(N)` columns
- ✅ Vector similarity operators work (`<->`, `<#>`, `<=>`)

## Notes

- **Init Scripts Directory:** PostgreSQL Docker image auto-executes scripts in `/docker-entrypoint-initdb.d/`
- **Execution Order:** Scripts run alphabetically (`.sql` and `.sh` files)
- **One-Time Execution:** Init scripts ONLY run if data directory is empty (first startup)
- **Idempotency:** Using `IF NOT EXISTS` makes script safe to run multiple times
- **Future Scripts:** PR 1.3 may add `02-create-schemas.sql` for initial schema setup

## Vector Operators Reference

For future use in RAG queries:

- **`<->`**: L2 distance (Euclidean)
- **`<#>`**: Inner product (negative, for cosine similarity use with normalized vectors)
- **`<=>`**: Cosine distance

Example query for RAG (will be used in PR 2.3):
```sql
SELECT id, content, embedding <-> $1 AS distance
FROM dive_site_chunks
ORDER BY distance
LIMIT 5;
```

## Next Step

Proceed to **Step 3: Backend Environment Configuration** (update .env.example with DATABASE_URL).
