# Step 1.1: Create docker-compose.yml

**Objective:** Set up Docker Compose configuration with PostgreSQL 16 + pgvector image

## Files to Create

- `docker-compose.yml` (root of project)

## Implementation

### Step-by-Step Instructions

#### Step 1: Create docker-compose.yml

Create a new file at the root of the project:

```yaml
version: '3.9'

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: dovvydive-postgres
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: dovvydive
      POSTGRES_USER: dovvydive
      POSTGRES_PASSWORD: dev_password
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    
    ports:
      - "5432:5432"
    
    volumes:
      # Named volume for data persistence
      - dovvydive-postgres-data:/var/lib/postgresql/data
      # Mount initialization scripts
      - ./docker/postgres/init-scripts:/docker-entrypoint-initdb.d:ro
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dovvydive -d dovvydive"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    networks:
      - dovvydive-network

networks:
  dovvydive-network:
    driver: bridge

volumes:
  dovvydive-postgres-data:
    name: dovvydive-postgres-data
```

**Key Configuration Explained:**

- **image**: Uses official `pgvector/pgvector:pg16` which includes PostgreSQL 16 with pgvector pre-compiled
- **container_name**: Fixed name for easier reference in logs and commands
- **restart**: Container auto-restarts unless explicitly stopped
- **environment**: 
  - Database name, user, and password for local dev
  - `POSTGRES_HOST_AUTH_METHOD` set to `scram-sha-256` for modern authentication
- **ports**: Maps container port 5432 to host port 5432
- **volumes**: 
  - Named volume for persistent data storage
  - Read-only mount of init scripts directory
- **healthcheck**: Ensures database is ready before backend connects
- **networks**: Isolated network for service communication

## Verification Steps

### 1. Start the Container

```bash
docker compose up -d
```

Expected output:
```
[+] Running 3/3
 ✔ Network dovvydive-network           Created
 ✔ Volume "dovvydive-postgres-data"    Created
 ✔ Container dovvydive-postgres        Started
```

### 2. Check Container Status

```bash
docker compose ps
```

Expected output (after ~30 seconds):
```
NAME                 IMAGE                    STATUS                    PORTS
dovvydive-postgres   pgvector/pgvector:pg16   Up (healthy)             0.0.0.0:5432->5432/tcp
```

**Important:** Status should show `Up (healthy)` - this confirms the healthcheck passed.

### 3. View Logs

```bash
docker compose logs postgres
```

Expected to see:
```
dovvydive-postgres  | PostgreSQL init process complete; ready for start up.
dovvydive-postgres  | database system is ready to accept connections
```

### 4. Test Database Connection

Using `psql` (if installed):
```bash
psql -h localhost -U dovvydive -d dovvydive
# Password: dev_password
```

Using Docker exec:
```bash
docker compose exec postgres psql -U dovvydive -d dovvydive
```

Once connected, verify PostgreSQL version:
```sql
SELECT version();
```

Should show PostgreSQL 16.x

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| Port 5432 already in use | Local PostgreSQL running | Stop local PostgreSQL: `sudo systemctl stop postgresql` (Linux) or change port mapping to `5433:5432` |
| Container status is "unhealthy" | Database not ready yet | Wait 30 seconds and check again: `docker compose ps` |
| Permission denied on volume | Linux volume permissions | Run: `sudo chown -R $USER:$USER ./docker` |
| Image pull fails | Network/registry issue | Check internet connection, retry: `docker compose pull` |
| Container exits immediately | Configuration error | Check logs: `docker compose logs postgres` for error messages |

## Success Criteria

- ✅ `docker compose up -d` starts container without errors
- ✅ Container shows "Up (healthy)" status within 30 seconds
- ✅ Can connect to database on `localhost:5432`
- ✅ PostgreSQL version is 16.x
- ✅ Logs show "ready to accept connections"

## Notes

- **Data Persistence:** Data survives `docker compose down` but is deleted with `docker compose down -v`
- **Port Conflicts:** If port 5432 is in use, change the port mapping to `5433:5432` and update `DATABASE_URL` accordingly
- **M1/M2 Macs:** The pgvector image supports ARM64 natively, no additional configuration needed
- **Windows WSL2:** Docker Desktop should handle this automatically

## Next Step

Proceed to **Step 1.2: Create .dockerignore** to optimize Docker build context.
