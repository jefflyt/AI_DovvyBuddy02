# Step 4.1: Add Docker Management npm Scripts

**Objective:** Add convenient npm scripts to root package.json for Docker Compose operations

## Files to Modify

- `package.json` (root)

## Implementation

### Step-by-Step Instructions

#### Step 1: Update Root package.json Scripts Section

Add Docker management scripts to the `"scripts"` section:

```json
{
  "name": "@dovvydive/root",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "src/frontend",
    "src/backend",
    "src/shared"
  ],
  "scripts": {
    "lint": "eslint . --ext .ts,.tsx",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "format:check": "prettier --check \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "type-check": "tsc --noEmit",
    
    "docker:up": "docker compose up -d",
    "docker:down": "docker compose down",
    "docker:logs": "docker compose logs -f postgres",
    "docker:restart": "docker compose restart postgres",
    "docker:clean": "docker compose down -v && echo 'Database volumes removed. Run npm run docker:up to start fresh.'",
    "docker:ps": "docker compose ps",
    "docker:shell": "docker compose exec postgres psql -U dovvydive -d dovvydive"
  },
  "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^6.19.0",
    "@typescript-eslint/parser": "^6.19.0",
    "eslint": "^8.56.0",
    "eslint-config-prettier": "^9.1.0",
    "prettier": "^3.2.4",
    "typescript": "^5.3.3"
  }
}
```

**Script Descriptions:**

| Script | Command | Purpose |
|--------|---------|---------|
| `docker:up` | `docker compose up -d` | Start PostgreSQL in detached mode |
| `docker:down` | `docker compose down` | Stop and remove containers (keeps volumes) |
| `docker:logs` | `docker compose logs -f postgres` | Follow PostgreSQL logs in real-time |
| `docker:restart` | `docker compose restart postgres` | Restart PostgreSQL container |
| `docker:clean` | `docker compose down -v` | Stop containers and **DELETE all data** |
| `docker:ps` | `docker compose ps` | Show container status |
| `docker:shell` | `docker compose exec postgres psql...` | Open PostgreSQL shell |

## Verification Steps

### 1. Verify Scripts Added

```bash
npm run
```

Expected output should include:
```
Scripts available via `npm run-script`:
  docker:up
    docker compose up -d
  docker:down
    docker compose down
  docker:logs
    docker compose logs -f postgres
  ...
```

### 2. Test docker:up

```bash
npm run docker:up
```

Expected output:
```
> @dovvydive/root@1.0.0 docker:up
> docker compose up -d

[+] Running 1/1
 ✔ Container dovvydive-postgres  Started
```

### 3. Test docker:ps

```bash
npm run docker:ps
```

Expected output:
```
> @dovvydive/root@1.0.0 docker:ps
> docker compose ps

NAME                 IMAGE                    STATUS                   PORTS
dovvydive-postgres   pgvector/pgvector:pg16   Up (healthy)            0.0.0.0:5432->5432/tcp
```

### 4. Test docker:logs

```bash
npm run docker:logs
```

Expected output (press Ctrl+C to exit):
```
> @dovvydive/root@1.0.0 docker:logs
> docker compose logs -f postgres

dovvydive-postgres  | 2025-12-01 12:00:00.000 UTC [1] LOG:  database system is ready to accept connections
```

### 5. Test docker:shell

```bash
npm run docker:shell
```

Expected: Opens PostgreSQL shell
```
> @dovvydive/root@1.0.0 docker:shell
> docker compose exec postgres psql -U dovvydive -d dovvydive

psql (16.1)
Type "help" for help.

dovvydive=#
```

Type `\q` to exit.

### 6. Test docker:restart

```bash
npm run docker:restart
```

Expected output:
```
> @dovvydive/root@1.0.0 docker:restart
> docker compose restart postgres

[+] Restarting 1/1
 ✔ Container dovvydive-postgres  Restarted
```

### 7. Test docker:down

```bash
npm run docker:down
```

Expected output:
```
> @dovvydive/root@1.0.0 docker:down
> docker compose down

[+] Running 2/2
 ✔ Container dovvydive-postgres  Removed
 ✔ Network dovvydive-network     Removed
```

### 8. Test docker:clean (CAUTION: Deletes Data)

```bash
npm run docker:clean
```

Expected output:
```
> @dovvydive/root@1.0.0 docker:clean
> docker compose down -v && echo 'Database volumes removed. Run npm run docker:up to start fresh.'

[+] Running 3/3
 ✔ Container dovvydive-postgres    Removed
 ✔ Volume dovvydive-postgres-data  Removed
 ✔ Network dovvydive-network       Removed
Database volumes removed. Run npm run docker:up to start fresh.
```

## Troubleshooting

| Issue | Cause | Solution |
|-------|-------|----------|
| Command not found: docker | Docker not installed | Install Docker Desktop or Docker Engine |
| Permission denied (Linux) | User not in docker group | Run: `sudo usermod -aG docker $USER && newgrp docker` |
| Scripts don't appear | JSON syntax error | Validate package.json: `npm run` |
| Container not found | Docker not running | Start Docker Desktop or run `docker compose up -d` |

## Success Criteria

- ✅ All Docker scripts added to root `package.json`
- ✅ `npm run docker:up` starts PostgreSQL container
- ✅ `npm run docker:down` stops containers cleanly
- ✅ `npm run docker:logs` shows real-time logs
- ✅ `npm run docker:shell` opens PostgreSQL shell
- ✅ `npm run docker:ps` shows container status
- ✅ `npm run docker:clean` removes volumes with warning message

## Notes

- **Data Safety:** `docker:down` preserves data; `docker:clean` deletes everything
- **Detached Mode:** `-d` flag runs containers in background
- **Logs:** `-f` flag follows logs in real-time (Ctrl+C to exit)
- **Shell Access:** Useful for running manual SQL queries during development
- **Future Enhancement:** Can add `docker:backup` and `docker:restore` scripts in later PRs

## Common Workflows

**Daily Development:**
```bash
npm run docker:up      # Start database
# ... develop backend ...
npm run docker:down    # Stop at end of day
```

**Debugging:**
```bash
npm run docker:logs    # Check logs
npm run docker:shell   # Run SQL queries manually
```

**Fresh Start:**
```bash
npm run docker:clean   # Delete all data
npm run docker:up      # Start fresh database
```

**Check Status:**
```bash
npm run docker:ps      # See if containers are running
```

## Next Step

Proceed to **Step 5: Documentation Updates** (update README with Docker setup guide).
